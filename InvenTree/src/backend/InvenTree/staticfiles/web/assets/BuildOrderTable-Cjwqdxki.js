import{r as o,j as t,ad as T,bk as R,am as q,aU as M,b1 as O,b4 as A,b5 as D,i,S as E,bD as f}from"./vendor-9x6k4T-r.js";import{u as y,S as F,g as L,A as P}from"./UseForm-C7xHtQGh.js";import{a as g,P as v,R as B,S as U,c as w,C as I,T as V,j as Q,f as N}from"./ColumnRenderers-CTwRHGdM.js";import{S as W,b as z}from"./Instance-ZaRjKoLj.js";import{l as G,e as k,A as x,m as b,c as H,U as X}from"./index-Bd_yPD7D.js";import{R as S}from"./RemoveRowButton-PzDbXrvR.js";import{u as $}from"./UseGenerator-BZWzvoyo.js";import{u as K}from"./UsePlaceholder-C_lBT7aw.js";import{u as J,a as Y,b as Z}from"./UseFilter-DqHeVZaa.js";import{u as ee,b as te,O as ae,c as se,A as ie,M as re,d as oe,C as le,e as ne,T as ue,f as ce,g as de,h as me,P as _e,H as pe,i as fe,I as he}from"./InvenTreeTable-KDc6oHjF.js";function xe({create:e}){const[a,r]=o.useState(null),[l,u]=o.useState(""),c=$(d=>{l||u(d)}),s=G();return o.useMemo(()=>{const d={reference:{},part:{disabled:!e,filters:{assembly:!0,virtual:!1,active:s.isSet("BUILDORDER_REQUIRE_ACTIVE_PART")?!0:void 0,locked:s.isSet("BUILDORDER_REQUIRE_LOCKED_PART")?!0:void 0},onValueChange(m,n){n&&r(n.default_location||n.category_default_location),c.update({part:m})}},title:{},quantity:{},project_code:{icon:t.jsx(T,{})},priority:{},parent:{icon:t.jsx(R,{}),filters:{part_detail:!0}},sales_order:{icon:t.jsx(q,{})},batch:{value:l,onValueChange:m=>u(m)},target_date:{icon:t.jsx(M,{})},take_from:{},destination:{filters:{structural:!1},value:a},link:{icon:t.jsx(O,{})},issued_by:{icon:t.jsx(A,{}),filters:{is_active:!0}},responsible:{icon:t.jsx(D,{}),filters:{is_active:!0}}};return e&&(d.create_child_builds={}),d},[e,a,l,s])}function qe({build:e}){var d,m;const a=o.useMemo(()=>{var n;return((n=e.part_detail)==null?void 0:n.trackable)??!1},[e.part_detail]),[r,l]=o.useState(null);o.useEffect(()=>{var n;l(e.location||((n=e.part_detail)==null?void 0:n.default_location)||null)},[e.location,e.part_detail]);const[u,c]=o.useState(0);o.useEffect(()=>{const n=e.quantity??0,_=e.completed??0;c(Math.max(0,n-_))},[e]);const s=K({partId:(d=e.part_detail)==null?void 0:d.pk,key:"build-output",enabled:(m=e.part_detail)==null?void 0:m.trackable});return o.useMemo(()=>({quantity:{value:u,onValueChange:n=>{c(n)}},serial_numbers:{hidden:!a,placeholder:s},batch_code:{},location:{value:r,onValueChange:n=>{c(n)}},auto_allocate:{hidden:!a}}),[u,s,a])}function C({props:e,record:a}){const r=o.useMemo(()=>a.serial?`# ${a.serial}`:`${i._({id:"VbWX2u"})}: ${a.quantity}`,[a]);return t.jsx(t.Fragment,{children:t.jsxs(f.Tr,{children:[t.jsx(f.Td,{children:t.jsx(g,{part:a.part_detail})}),t.jsx(f.Td,{children:t.jsx(L,{props:e,errorKey:"output",children:r})}),t.jsx(f.Td,{children:a.batch}),t.jsxs(f.Td,{children:[t.jsx(W,{status:a.status,type:b.stockitem})," "]}),t.jsx(f.Td,{style:{width:"1%",whiteSpace:"nowrap"},children:t.jsx(S,{onClick:()=>e.removeFn(e.idx)})})]})})}function Me({build:e,outputs:a,onFormSuccess:r}){const[l,u]=o.useState(null);o.useEffect(()=>{var s;l||u(e.destination||((s=e.part_detail)==null?void 0:s.default_location)||null)},[l,e.destination,e.part_detail]);const c=o.useMemo(()=>({outputs:{field_type:"table",value:a.map(s=>({output:s.pk})),modelRenderer:s=>{const d=a.find(m=>m.pk==s.item.output);return t.jsx(C,{props:s,record:d},d.pk)},headers:[i._({id:"vgP+9p"}),i._({id:"gILim+"}),i._({id:"rsx3xA"}),i._({id:"uAQUqI"})]},status_custom_key:{},location:{filters:{structural:!1},value:l,onValueChange:s=>{u(s)}},notes:{},accept_incomplete_allocation:{}}),[l,a]);return y({url:k(x.build_output_complete,e.pk),method:"POST",title:i._({id:"0iR9fu"}),fields:c,onFormSuccess:r,successMessage:i._({id:"N3avUJ"}),size:"80%"})}function Oe({build:e,outputs:a,onFormSuccess:r}){const[l,u]=o.useState(null);o.useEffect(()=>{var s;l||u(e.destination||((s=e.part_detail)==null?void 0:s.default_location)||null)},[l,e.destination,e.part_detail]);const c=o.useMemo(()=>({outputs:{field_type:"table",value:a.map(s=>({output:s.pk,quantity:s.quantity})),modelRenderer:s=>{const d=a.find(m=>m.pk==s.item.output);return t.jsx(C,{props:s,record:d},d.pk)},headers:[i._({id:"vgP+9p"}),i._({id:"igx8Og"}),i._({id:"rsx3xA"}),i._({id:"uAQUqI"})]},location:{value:l,onValueChange:s=>{u(s)}},notes:{},discard_allocations:{}}),[l,a]);return y({url:k(x.build_output_scrap,e.pk),method:"POST",title:i._({id:"69qbY/"}),fields:c,onFormSuccess:r,successMessage:i._({id:"C+tSd4"}),size:"80%"})}function Ae({build:e,outputs:a,onFormSuccess:r}){const l=o.useMemo(()=>({outputs:{field_type:"table",value:a.map(u=>({output:u.pk})),modelRenderer:u=>{const c=a.find(s=>s.pk==u.item.output);return t.jsx(C,{props:u,record:c},c.pk)},headers:[i._({id:"vgP+9p"}),i._({id:"igx8Og"}),i._({id:"rsx3xA"}),i._({id:"uAQUqI"})]}}),[a]);return y({url:k(x.build_output_delete,e.pk),method:"POST",title:i._({id:"xS5DxW"}),fields:l,onFormSuccess:r,successMessage:i._({id:"cdFWk4"}),size:"80%"})}function be({props:e,record:a,sourceLocation:r}){var c,s,d,m;const l=o.useMemo(()=>({field_type:"related field",api_url:k(x.stock_item_list),model:b.stockitem,filters:{available:!0,part_detail:!0,location_detail:!0,bom_item:a.bom_item,location:r,cascade:r?!0:void 0},value:e.item.stock_item,name:"stock_item",onValueChange:(n,_)=>{if(e.changeFn(e.idx,"stock_item",n),_){const h=_.quantity-_.allocated;h<e.item.quantity&&e.changeFn(e.idx,"quantity",Math.min(e.item.quantity,h))}}}),[a,e]),u=o.useMemo(()=>({field_type:"number",name:"quantity",required:!0,value:e.item.quantity,onValueChange:n=>{e.changeFn(e.idx,"quantity",n)}}),[e]);return t.jsxs(f.Tr,{children:[t.jsx(f.Td,{children:t.jsx(g,{part:a.part_detail})}),t.jsx(f.Td,{children:t.jsx(v,{value:a.allocatedQuantity,maximum:a.requiredQuantity,progressLabel:!0})}),t.jsx(f.Td,{children:t.jsx(F,{fieldName:"stock_item",fieldDefinition:l,error:(s=(c=e.rowErrors)==null?void 0:c.stock_item)==null?void 0:s.message})}),t.jsx(f.Td,{children:t.jsx(F,{fieldName:"quantity",fieldDefinition:u,error:(m=(d=e.rowErrors)==null?void 0:d.quantity)==null?void 0:m.message})}),t.jsx(f.Td,{children:t.jsx(S,{onClick:()=>e.removeFn(e.idx)})})]},`table-row-${a.pk}`)}function De({buildId:e,outputId:a,build:r,lineItems:l,onFormSuccess:u}){const[c,s]=o.useState(void 0),d=o.useMemo(()=>({items:{field_type:"table",value:[],headers:[i._({id:"vgP+9p"}),i._({id:"A/ybx7"}),i._({id:"igx8Og"}),i._({id:"VbWX2u"})],modelRenderer:h=>{const j=l.find(p=>p.pk==h.item.build_line)??{};return t.jsx(be,{props:h,record:j,sourceLocation:c},h.idx)}}}),[l,c]);o.useEffect(()=>{s(r==null?void 0:r.take_from)},[r==null?void 0:r.take_from]);const m=o.useMemo(()=>({field_type:"related field",api_url:k(x.stock_location_list),model:b.stocklocation,required:!1,label:i._({id:"/00Ond"}),description:i._({id:"IArqwk"}),name:"source_location",value:r==null?void 0:r.take_from,onValueChange:_=>{s(_)}}),[r==null?void 0:r.take_from]),n=o.useMemo(()=>t.jsx(E,{gap:"xs",children:t.jsx(F,{fieldDefinition:m})}),[m]);return y({url:x.build_order_allocate,pk:e,title:i._({id:"L1LMmH"}),fields:d,preFormContent:n,successMessage:i._({id:"23SrHL"}),onFormSuccess:u,initialData:{items:l.map(_=>({build_line:_.pk,stock_item:void 0,quantity:Math.max(0,_.requiredQuantity-_.allocatedQuantity),output:a}))},size:"80%"})}function Ee({partId:e,parentBuildId:a,salesOrderId:r}){const l=ee(e?"buildorder-part":"buildorder-index"),u=o.useMemo(()=>[B({}),{accessor:"part",sortable:!0,switchable:!1,render:p=>g({part:p.part_detail})},{accessor:"part_detail.IPN",sortable:!0,switchable:!0,title:i._({id:"3wXEsN"})},{accessor:"title",sortable:!1},{accessor:"completed",sortable:!0,switchable:!1,render:p=>t.jsx(v,{progressLabel:!0,value:p.completed,maximum:p.quantity})},U({model:b.build}),w({}),{accessor:"level",sortable:!0,switchable:!0,hidden:!a},{accessor:"priority",sortable:!0},I({}),V({}),Q({accessor:"completion_date",title:i._({id:"41ha49"}),sortable:!0}),{accessor:"issued_by",sortable:!0,render:p=>t.jsx(z,{instance:p==null?void 0:p.issued_by_detail})},N({})],[a]),c=J(),s=Y(),d=Z(),m=o.useMemo(()=>{const p=[te(),ae({model:b.build}),se(),ie(),re(),oe(),le(),ne(),ue(),ce(),de(),me(),_e({choices:c.choices}),pe(),{name:"issued_by",label:i._({id:"kmUN8p"}),description:i._({id:"OEh/FL"}),choices:d.choices},fe({choices:s.choices})];return e&&p.push({name:"include_variants",type:"boolean",label:i._({id:"/g9i/Z"}),description:i._({id:"NkXwQy"})}),p},[e,c.choices,s.choices,d.choices]),n=H(),_=xe({create:!0}),h=y({url:x.build_order_list,title:i._({id:"59jtLx"}),fields:_,initialData:{part:e,sales_order:r,parent:a},follow:!0,modelType:b.build}),j=o.useMemo(()=>[t.jsx(P,{hidden:!n.hasAddRole(X.build),tooltip:i._({id:"59jtLx"}),onClick:()=>h.open()},"add-build-order")],[n]);return t.jsxs(t.Fragment,{children:[h.modal,t.jsx(he,{url:k(x.build_order_list),tableState:l,columns:u,props:{params:{part:e,ancestor:a,sales_order:r,part_detail:!0},tableActions:j,tableFilters:m,modelType:b.build,enableSelection:!0,enableReports:!0,enableDownload:!0}})]})}export{Ee as B,De as a,qe as b,Me as c,Oe as d,Ae as e,xe as u};
