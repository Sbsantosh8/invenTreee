import{r as o,j as t,bg as oe,ad as ce,dB as Q,aU as W,b4 as de,d$ as re,e0 as ue,bA as _e,i as a,aP as fe,bk as xe,as as ge,b1 as me,ce as m,y as he,bS as je,bT as be,bD as x,cq as F,dA as pe,G as ve,l as ye}from"./vendor-9x6k4T-r.js";import{d as ke}from"./dayjs.min-DUmzidR_.js";import{e as v,A as y,l as Ce,m as Fe,a as Te}from"./index-Bd_yPD7D.js";import{u as Ae,S as X,c as r,T as j}from"./UseForm-C7xHtQGh.js";import{R as Ee}from"./RemoveRowButton-PzDbXrvR.js";import{T as Se}from"./Instance-ZaRjKoLj.js";import{P as we}from"./ColumnRenderers-CTwRHGdM.js";import{S as Ie,I as c}from"./ThemeContext-DRe09WSE.js";import{u as De,a as qe}from"./UseGenerator-BZWzvoyo.js";function He({supplierId:e,orderId:i,create:_}){const[l,h]=o.useState(""),[s,u]=o.useState(!0);return o.useEffect(()=>{s&&h("")},[s]),o.useEffect(()=>{u(l==="")},[l]),o.useMemo(()=>{const f={order:{filters:{supplier_detail:!0},disabled:!0},part:{filters:{part_detail:!0,supplier_detail:!0,active:!0,part_active:!0},adjustFilters:b=>({...b.filters,supplier:e})},quantity:{},reference:{},purchase_price:{icon:t.jsx(fe,{}),value:l,onValueChange:h},purchase_price_currency:{icon:t.jsx(Q,{})},auto_pricing:{value:s,onValueChange:u},target_date:{icon:t.jsx(W,{})},destination:{icon:t.jsx(xe,{})},notes:{icon:t.jsx(ge,{})},link:{icon:t.jsx(me,{})}};return _&&(f.merge_items={}),f},[_,i,e,s,l])}function Je({supplierId:e,duplicateOrderId:i}){return o.useMemo(()=>{const _={reference:{icon:t.jsx(oe,{})},description:{},supplier:{value:e,disabled:!!i||!!e,filters:{is_supplier:!0,active:!0}},supplier_reference:{},project_code:{icon:t.jsx(ce,{})},order_currency:{icon:t.jsx(Q,{})},target_date:{icon:t.jsx(W,{})},destination:{filters:{structural:!1}},link:{},contact:{icon:t.jsx(de,{}),adjustFilters:l=>({...l.filters,company:l.data.supplier})},address:{icon:t.jsx(re,{}),adjustFilters:l=>({...l.filters,company:l.data.supplier})},responsible:{filters:{is_active:!0},icon:t.jsx(ue,{})}};return i&&(_.duplicate={children:{order_id:{hidden:!0,value:i},copy_lines:{},copy_extra_lines:{}}}),_},[i,e])}function Ve({props:e,record:i,statuses:_}){var D,q,V,P,O,B,L,M,R,G,K,N,H,J,U,z,Y;const[l,{open:h,close:s}]=m(!1,{onClose:()=>e.changeFn(e.idx,"barcode",void 0)}),[u,g]=m(!1,{onClose:()=>e.changeFn(e.idx,"location",void 0)}),f=o.useMemo(()=>{var n;return((n=i.part_detail)==null?void 0:n.trackable)??!1},[i]),b=Ce();o.useEffect(()=>{i.destination&&(e.changeFn(e.idx,"location",i.destination),g.open())},[i.destination]);const Z=De(n=>{n&&e.changeFn(e.idx,"batch_code",n)}),$=qe(n=>{n&&e.changeFn(e.idx,"serial_numbers",n)}),[T,ee]=m(!1,{onClose:()=>{e.changeFn(e.idx,"packaging",void 0)}}),[A,te]=m(!1,{onClose:()=>{e.changeFn(e.idx,"note",void 0)}}),[k,ie]=m(!1,{onClose:()=>{e.changeFn(e.idx,"batch_code",void 0),e.changeFn(e.idx,"serial_numbers",void 0)},onOpen:()=>{var n,d;Z.update({part:(n=i==null?void 0:i.supplier_part_detail)==null?void 0:n.part,order:i==null?void 0:i.order}),$.update({part:(d=i==null?void 0:i.supplier_part_detail)==null?void 0:d.part,quantity:e.item.quantity})}}),[E,ne]=m(!1,{onOpen:()=>{var d;const n=(d=i.part_detail)==null?void 0:d.default_expiry;n!==void 0&&n>0&&e.changeFn(e.idx,"expiry_date",ke().add(n,"day").format("YYYY-MM-DD"))},onClose:()=>{e.changeFn(e.idx,"expiry_date",void 0)}}),[S,ae]=m(!1,{onClose:()=>e.changeFn(e.idx,"status",void 0)}),[p,w]=o.useState(""),[C,I]=o.useState(void 0);o.useEffect(()=>{e.changeFn(e.idx,"barcode",C)},[C]);const se=o.useMemo(()=>f?a._({id:"W778m0"}):a._({id:"K5pQC8"}),[f]);o.useEffect(()=>{if(!l)return;const n=setTimeout(()=>{I(p.length?p:null),s(),w("")},500);return()=>clearTimeout(n)},[p]);const le=o.useMemo(()=>{var d;const n=a._({id:"RL9/J8"});return location===null?n:location===i.destination?a._({id:"LNKjyK"}):!i.destination&&!i.destination_detail&&i.part_detail&&location===((d=i.part_detail)==null?void 0:d.category_default_location)?a._({id:"q3WAIO"}):!i.destination&&i.destination_detail&&location===i.destination_detail.pk&&i.received>0?a._({id:"K1Mf+T"}):location===i.part_detail.default_location?a._({id:"ALFlH9"}):n},[location]);return t.jsxs(t.Fragment,{children:[t.jsx(he,{opened:l,onClose:s,title:t.jsx(Ie,{children:a._({id:"fNvDwV"})}),children:t.jsx(je,{children:t.jsx(be,{label:"Barcode data","data-autofocus":!0,value:p,onChange:n=>w(n.target.value)})})}),t.jsxs(x.Tr,{children:[t.jsx(x.Td,{children:t.jsxs(F,{gap:"sm",align:"center",children:[t.jsx(Se,{size:40,src:i.part_detail.thumbnail,align:"center"}),t.jsx("div",{children:i.part_detail.name})]})}),t.jsx(x.Td,{children:i.supplier_part_detail.SKU}),t.jsx(x.Td,{children:t.jsx(we,{value:i.received,maximum:i.quantity,progressLabel:!0})}),t.jsx(x.Td,{style:{whiteSpace:"nowrap"},children:t.jsx(X,{fieldName:"quantity",fieldDefinition:{field_type:"number",value:e.item.quantity,onValueChange:n=>e.changeFn(e.idx,"quantity",n)},error:(q=(D=e.rowErrors)==null?void 0:D.quantity)==null?void 0:q.message})}),t.jsx(x.Td,{style:{width:"1%",whiteSpace:"nowrap"},children:t.jsxs(F,{gap:"1px",children:[t.jsx(r,{size:"sm",onClick:()=>g.toggle(),icon:t.jsx(c,{icon:"location"}),tooltip:a._({id:"TJYLHZ"}),tooltipAlignment:"top",variant:u?"filled":"transparent"}),t.jsx(r,{size:"sm",onClick:()=>ie.toggle(),icon:t.jsx(c,{icon:"batch_code"}),tooltip:se,tooltipAlignment:"top",variant:k?"filled":"transparent"}),b.isSet("STOCK_ENABLE_EXPIRY")&&t.jsx(r,{size:"sm",onClick:()=>ne.toggle(),icon:t.jsx(pe,{}),tooltip:a._({id:"okjJiB"}),tooltipAlignment:"top",variant:E?"filled":"transparent"}),t.jsx(r,{size:"sm",icon:t.jsx(c,{icon:"packaging"}),tooltip:a._({id:"O7MZ1G"}),tooltipAlignment:"top",onClick:()=>ee.toggle(),variant:T?"filled":"transparent"}),t.jsx(r,{onClick:()=>ae.toggle(),icon:t.jsx(c,{icon:"status"}),tooltip:a._({id:"Gt4cm5"}),tooltipAlignment:"top",variant:S?"filled":"transparent"}),t.jsx(r,{icon:t.jsx(c,{icon:"note"}),tooltip:a._({id:"nxv8yE"}),tooltipAlignment:"top",variant:A?"filled":"transparent",onClick:()=>te.toggle()}),C?t.jsx(r,{icon:t.jsx(c,{icon:"unlink"}),tooltip:a._({id:"ut1J8k"}),tooltipAlignment:"top",variant:"filled",color:"red",onClick:()=>I(void 0)}):t.jsx(r,{icon:t.jsx(c,{icon:"barcode"}),tooltip:a._({id:"fNvDwV"}),tooltipAlignment:"top",variant:"transparent",onClick:()=>h()}),t.jsx(Ee,{onClick:()=>e.removeFn(e.idx)})]})})]}),u&&t.jsx(x.Tr,{children:t.jsx(x.Td,{colSpan:10,children:t.jsxs(ve,{grow:!0,preventGrowOverflow:!1,justify:"flex-apart",p:"xs",children:[t.jsx(ye,{flex:0,p:"xs",children:t.jsx(c,{icon:"downright"})}),t.jsx(X,{fieldDefinition:{field_type:"related field",model:Fe.stocklocation,api_url:v(y.stock_location_list),filters:{structural:!1},onValueChange:n=>{e.changeFn(e.idx,"location",n)},description:le,value:e.item.location,label:a._({id:"wJijgU"}),icon:t.jsx(c,{icon:"location"})},defaultValue:i.destination??(i.destination_detail?i.destination_detail.pk:null)}),t.jsxs(F,{style:{marginBottom:"7px"},children:[(((V=i.part_detail)==null?void 0:V.default_location)||((P=i.part_detail)==null?void 0:P.category_default_location))&&t.jsx(r,{icon:t.jsx(c,{icon:"default_location"}),tooltip:a._({id:"j9qXAA"}),onClick:()=>{var n,d;return e.changeFn(e.idx,"location",((n=i.part_detail)==null?void 0:n.default_location)??((d=i.part_detail)==null?void 0:d.category_default_location))},tooltipAlignment:"top"}),i.destination&&t.jsx(r,{icon:t.jsx(c,{icon:"destination"}),tooltip:a._({id:"NOgnJu"}),onClick:()=>e.changeFn(e.idx,"location",i.destination),tooltipAlignment:"top"}),!i.destination&&i.destination_detail&&i.received>0&&t.jsx(r,{icon:t.jsx(c,{icon:"repeat_destination"}),tooltip:a._({id:"CKgjtC"}),onClick:()=>e.changeFn(e.idx,"location",i.destination_detail.pk),tooltipAlignment:"top"})]})]})})}),t.jsx(j,{visible:k,onValueChange:n=>e.changeFn(e.idx,"batch",n),fieldDefinition:{field_type:"string",label:a._({id:"Vea6Aj"}),description:a._({id:"s848yO"}),value:e.item.batch_code},error:(B=(O=e.rowErrors)==null?void 0:O.batch_code)==null?void 0:B.message}),t.jsx(j,{visible:k&&f,onValueChange:n=>e.changeFn(e.idx,"serial_numbers",n),fieldDefinition:{field_type:"string",label:a._({id:"VzQT2x"}),description:a._({id:"ig+UDq"}),value:e.item.serial_numbers},error:(M=(L=e.rowErrors)==null?void 0:L.serial_numbers)==null?void 0:M.message}),b.isSet("STOCK_ENABLE_EXPIRY")&&t.jsx(j,{visible:E,onValueChange:n=>e.changeFn(e.idx,"expiry_date",n),fieldDefinition:{field_type:"date",label:a._({id:"uaSvqt"}),description:a._({id:"ICgiSv"}),value:e.item.expiry_date},error:(G=(R=e.rowErrors)==null?void 0:R.expiry_date)==null?void 0:G.message}),t.jsx(j,{visible:T,onValueChange:n=>e.changeFn(e.idx,"packaging",n),fieldDefinition:{field_type:"string",label:a._({id:"pD/Ew0"})},defaultValue:(K=i==null?void 0:i.supplier_part_detail)==null?void 0:K.packaging,error:(H=(N=e.rowErrors)==null?void 0:N.packaging)==null?void 0:H.message}),t.jsx(j,{visible:S,defaultValue:10,onValueChange:n=>e.changeFn(e.idx,"status",n),fieldDefinition:{field_type:"choice",api_url:v(y.stock_status),choices:_,label:a._({id:"uAQUqI"})},error:(U=(J=e.rowErrors)==null?void 0:J.status)==null?void 0:U.message}),t.jsx(j,{visible:A,onValueChange:n=>e.changeFn(e.idx,"note",n),fieldDefinition:{field_type:"string",label:a._({id:"KiJn9B"})},error:(Y=(z=e.rowErrors)==null?void 0:z.note)==null?void 0:Y.message})]})}function Ue(e){const{data:i}=_e({queryKey:["stock","status"],queryFn:async()=>Te.get(v(y.stock_status)).then(s=>{if(s.status===200)return Object.values(s.data.values).map(f=>({value:f.key,display_name:f.label}))})}),_=Object.fromEntries(e.items.map(s=>[s.pk,s])),l=e.items.filter(s=>s.quantity!==s.received),h={id:{value:e.orderPk,hidden:!0},items:{field_type:"table",value:l.map((s,u)=>{var g;return{line_item:s.pk,location:s.destination??((g=s.destination_detail)==null?void 0:g.pk)??null,quantity:s.quantity-s.received,expiry_date:null,batch_code:"",serial_numbers:"",status:10,barcode:null}}),modelRenderer:s=>{const u=_[s.item.line_item];return t.jsx(Ve,{props:s,record:u,statuses:i},u.pk)},headers:[a._({id:"vgP+9p"}),a._({id:"y90mqQ"}),a._({id:"fZ5Vnu"}),a._({id:"VbWX2u"}),a._({id:"7L01XJ"})]},location:{filters:{structural:!1}}};return Ae({...e.formProps,url:v(y.purchase_order_receive,e.orderPk),title:a._({id:"MXlhj9"}),fields:h,initialData:{location:e.destinationPk},size:"80%"})}export{Ue as a,He as b,Je as u};
