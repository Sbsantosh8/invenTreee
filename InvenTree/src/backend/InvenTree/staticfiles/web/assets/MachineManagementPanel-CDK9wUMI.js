import{j as e,cx as ie,r as p,G as _,m as j,bC as q,i,cy as V,B as Q,bA as L,n as re,aM as ne,S as b,T as B,ax as Y,bI as a,bW as I,bF as K,cq as le,fe as A,d4 as N,bG as W,d as ae,bz as X,Z}from"./vendor-9x6k4T-r.js";import{A as y,e as w,a as de}from"./index-Bd_yPD7D.js";import{e as T,a as F,S as M}from"./ThemeContext-DRe09WSE.js";import{u as oe,A as ce,a as xe,b as ue}from"./UseForm-C7xHtQGh.js";import{Y as J}from"./YesNoButton-BsHbI51V.js";import{O as je,E as pe,D as he}from"./ActionDropdown-DlGcqXhK.js";import{I as c}from"./InfoItem-CPavuCqD.js";import{D as R,a as D}from"./DetailDrawer-DT_CXWKz.js";import{a as _e,S as me}from"./Instance-ZaRjKoLj.js";import{M as H}from"./SettingList-B-7Q1HIu.js";import{u as P}from"./DesktopAppView-D7dqNL6j.js";import{u as U,I as G}from"./InvenTreeTable-KDc6oHjF.js";import{B as E}from"./ColumnRenderers-CTwRHGdM.js";import"./dayjs.min-DUmzidR_.js";import"./ApiIcon-BBFuOj6_.js";import"./navigation-BUwul1Ze.js";import"./formatters-MBbtNL9a.js";function $(){return e.jsx(ie,{size:18,color:"red"})}function ee({machine:n}){const d={marginLeft:"4px"};if(!n.active)return e.jsx(V,{style:d,color:"gray",children:e.jsx(Q,{})});let l="green";n.machine_errors.length>0||!n.is_driver_available||n.status>=300?l="red":n.status>=200&&(l="orange");const s=n.initialized&&n.status>0&&n.status<300;return e.jsx(V,{processing:s,style:d,color:l,children:e.jsx(Q,{})})}function S({includeTypes:n=!0,includeDrivers:d=!0}={}){const l=P(),{data:o,isFetching:s,refetch:t}=L({enabled:n,queryKey:["machine-types"],queryFn:()=>l.get(w(y.machine_types_list)).then(x=>x.data),staleTime:10*1e3}),{data:f,isFetching:g,refetch:u}=L({enabled:d,queryKey:["machine-drivers"],queryFn:()=>l.get(w(y.machine_driver_list)).then(x=>x.data),staleTime:10*1e3}),m=p.useCallback(()=>{t(),u()},[u,t]);return{machineTypes:o,machineDrivers:f,isFetching:s||g,refresh:m}}function fe({machinePk:n,refreshTable:d}){const l=P(),o=T(),{data:s,refetch:t,isFetching:f}=L({enabled:!0,queryKey:["machine-detail",n],queryFn:()=>l.get(w(y.machine_list,n)).then(C=>C.data)}),{machineTypes:g,machineDrivers:u,isFetching:m}=S(),x=f||m,h=p.useMemo(()=>g&&s?g.find(C=>C.slug===s.machine_type):void 0,[s==null?void 0:s.machine_type,g]),k=p.useMemo(()=>u&&s?u.find(C=>C.slug===s.driver):void 0,[s==null?void 0:s.driver,u]),r=p.useCallback(()=>{t(),d()},[t,d]),v=p.useCallback(C=>{l.post(w(y.machine_restart,void 0,{machine:C})).then(()=>{r(),re.show({message:i._({id:"8hvWaA"}),color:"green",icon:e.jsx(ne,{size:"1rem"})})})},[r]),z=xe({title:i._({id:"RBquff"}),url:y.machine_list,pk:n,fields:p.useMemo(()=>({name:{},active:{}}),[]),onClose:()=>r()}),O=ue({title:i._({id:"5ihjEH"}),successMessage:i._({id:"ZbXCol"}),url:y.machine_list,pk:n,preFormContent:e.jsx(j,{children:i._({id:"Y9eJUJ",values:{0:s==null?void 0:s.name}})}),onFormSuccess:()=>{d(),o(-1)}});return e.jsx(e.Fragment,{children:e.jsxs(b,{gap:"xs",children:[z.modal,O.modal,e.jsxs(_,{justify:"space-between",children:[e.jsxs(_,{children:[s&&e.jsx(ee,{machine:s}),e.jsx(B,{order:4,children:s==null?void 0:s.name})]}),e.jsxs(_,{children:[(s==null?void 0:s.restart_required)&&e.jsx(q,{color:"red",children:e.jsx(F,{id:"dKwnjv"})}),e.jsx(je,{tooltip:i._({id:"72f9dQ"}),actions:[pe({tooltip:i._({id:"RBquff"}),onClick:z.open}),he({tooltip:i._({id:"5ihjEH"}),onClick:O.open}),{icon:e.jsx(Y,{}),name:i._({id:"6z9W13"}),tooltip:i._({id:"Plnldt"})+(s!=null&&s.restart_required?` (${i._({id:"kbLjlB"})})`:""),indicator:s!=null&&s.restart_required?{color:"red"}:void 0,onClick:()=>s&&v(s==null?void 0:s.pk)}]})]})]}),e.jsxs(a,{multiple:!0,defaultValue:["machine-info","machine-settings","driver-settings"],children:[e.jsxs(a.Item,{value:"machine-info",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"gz3Ont"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(b,{gap:"md",children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(K,{visible:x,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"pwL+bm"}),children:e.jsxs(_,{gap:"xs",children:[h?e.jsx(D,{to:`../type-${s==null?void 0:s.machine_type}`,text:h.name}):e.jsx(j,{children:s==null?void 0:s.machine_type}),s&&!h&&e.jsx($,{})]})}),e.jsx(c,{name:i._({id:"3ADt1I"}),children:e.jsxs(_,{gap:"xs",children:[k?e.jsx(D,{to:`../driver-${s==null?void 0:s.driver}`,text:k.name}):e.jsx(j,{children:s==null?void 0:s.driver}),!(s!=null&&s.is_driver_available)&&e.jsx($,{})]})}),e.jsx(c,{name:i._({id:"nsu9Un"}),children:e.jsx(J,{value:(s==null?void 0:s.initialized)||!1})}),e.jsx(c,{name:i._({id:"F6pfE9"}),children:e.jsx(J,{value:(s==null?void 0:s.active)||!1})}),e.jsx(c,{name:i._({id:"uAQUqI"}),children:e.jsxs(le,{direction:"column",children:[(s==null?void 0:s.status)===-1?e.jsx(j,{fz:"xs",children:"No status"}):me({status:`${(s==null?void 0:s.status)||-1}`,type:`MachineStatus__${s==null?void 0:s.status_model}`}),e.jsx(j,{fz:"sm",children:s==null?void 0:s.status_text})]})}),e.jsxs(_,{justify:"space-between",gap:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(F,{id:"UirGxE"}),":"]}),s&&(s==null?void 0:s.machine_errors.length)>0?e.jsx(q,{color:"red",style:{marginLeft:"10px"},children:s==null?void 0:s.machine_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(F,{id:"hIOaIF"})}),e.jsx(A,{w:"100%",children:s==null?void 0:s.machine_errors.map((C,te)=>e.jsx(A.Item,{children:e.jsx(N,{children:C})},te))})]})]})})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(a.Item,{value:"machine-settings",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"m57e2B"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(H,{machinePk:n,configType:"M",onChange:r})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(a.Item,{value:"driver-settings",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"fWJCep"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(H,{machinePk:n,configType:"D",onChange:r})})})]})]})]})})}function se({props:n,renderMachineDrawer:d=!0,createProps:l}){const{machineTypes:o,machineDrivers:s}=S(),t=U("machine"),f=T(),g=p.useMemo(()=>[{accessor:"name",sortable:!0,render:r=>e.jsxs(_,{justify:"left",wrap:"nowrap",children:[e.jsx(ee,{machine:r}),e.jsx(j,{children:r.name}),r.restart_required&&e.jsx(q,{color:"red",children:e.jsx(F,{id:"dKwnjv"})})]})},{accessor:"machine_type",sortable:!0,render:r=>{const v=o==null?void 0:o.find(z=>z.slug===r.machine_type);return e.jsxs(_,{gap:"xs",children:[e.jsx(j,{children:v?v.name:r.machine_type}),o&&!v&&e.jsx($,{})]})}},{accessor:"driver",sortable:!0,render:r=>{const v=s==null?void 0:s.find(z=>z.slug===r.driver);return e.jsxs(_,{gap:"xs",children:[e.jsx(j,{children:v?v.name:r.driver}),!r.is_driver_available&&e.jsx($,{})]})}},E({accessor:"initialized"}),E({accessor:"active"}),{accessor:"status",sortable:!1,render:r=>{const v=_e(`MachineStatus__${r.status_model}`);if(v&&r.status!==-1)return v(r)}}],[o]),[u,m]=p.useState(null),x=p.useMemo(()=>s?s.filter(r=>r.machine_type===u).map(r=>({value:r.slug,display_name:r.name})):[],[s,u]),h=oe({title:i._({id:"kZ/tbb"}),url:y.machine_list,fields:{name:{},machine_type:{hidden:!!(l!=null&&l.machine_type),...l!=null&&l.machine_type?{value:l.machine_type}:{},field_type:"choice",choices:o?o.map(r=>({value:r.slug,display_name:r.name})):[],onValueChange:r=>m(r)},driver:{hidden:!!(l!=null&&l.driver),...l!=null&&l.driver?{value:l.driver}:{},field_type:"choice",disabled:!u,choices:x},active:{}},onFormSuccess:r=>{t.refreshTable(),f(d?`machine-${r.pk}/`:`../machine-${r.pk}/`)},onClose:()=>{m(null)}}),k=p.useMemo(()=>[e.jsx(ce,{tooltip:i._({id:"kZ/tbb"}),onClick:()=>{m(null),h.open()}},"add-machine")],[h.open]);return e.jsxs(e.Fragment,{children:[h.modal,d&&e.jsx(R,{title:i._({id:"YDOU4Q"}),size:"xl",renderContent:r=>!r||!r.startsWith("machine-")?!1:e.jsx(fe,{machinePk:r.replace("machine-",""),refreshTable:t.refreshTable})}),e.jsx(G,{url:w(y.machine_list),tableState:t,columns:g,props:{...n,enableDownload:!1,onRowClick:r=>f(d?`machine-${r.pk}/`:`../machine-${r.pk}/`),tableActions:k,params:{...n.params},tableFilters:[{name:"active",label:i._({id:"F6pfE9"}),type:"boolean"},{name:"machine_type",label:i._({id:"pwL+bm"}),type:"choice",choiceFunction:()=>o?o.map(r=>({value:r.slug,label:r.name})):[]},{name:"driver",label:i._({id:"6ccUsd"}),type:"choice",choiceFunction:()=>s?s.map(r=>({value:r.slug,label:r.name})):[]}]}})]})}function ge({machineTypeSlug:n}){var u,m,x;const d=T(),{machineTypes:l,refresh:o,isFetching:s}=S({includeDrivers:!1}),t=p.useMemo(()=>l==null?void 0:l.find(h=>h.slug===n),[l,n]),f=U("machineDrivers"),g=p.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},{accessor:"description",title:i._({id:"Nu4oKW"})},E({accessor:"is_builtin",title:i._({id:"argeGI"})})],[]);return e.jsx(e.Fragment,{children:e.jsxs(b,{children:[e.jsx(_,{wrap:"nowrap",children:e.jsx(B,{order:4,children:t?t.name:n})}),!t&&e.jsx(W,{color:"red",title:i._({id:"pAtylB"}),icon:e.jsx(ae,{}),children:e.jsx(j,{children:i._({id:"FW2Ygg"})})}),e.jsxs(a,{multiple:!0,defaultValue:["machine-type-info","machine-drivers"],children:[e.jsxs(a.Item,{value:"machine-type-info",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"RRr8s4"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(K,{visible:s,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:i._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:i._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:i._({id:"umAemZ"}),value:(u=t==null?void 0:t.provider_plugin)==null?void 0:u.name,type:"text",link:((m=t==null?void 0:t.provider_plugin)==null?void 0:m.pk)!==null?`../../plugin/${(x=t==null?void 0:t.provider_plugin)==null?void 0:x.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:i._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:i._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"})]})})})]}),e.jsxs(a.Item,{value:"machine-drivers",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"qTGFbM"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(G,{url:w(y.machine_driver_list),tableState:f,columns:g,props:{dataFormatter:h=>h.filter(k=>k.machine_type===n),enableDownload:!1,enableSearch:!1,onRowClick:h=>d(`../driver-${h.slug}/`)}})})})]})]})]})})}function ve({machineDriverSlug:n}){var g,u,m;const{machineDrivers:d,machineTypes:l,refresh:o,isFetching:s}=S(),t=p.useMemo(()=>d==null?void 0:d.find(x=>x.slug===n),[d,n]),f=p.useMemo(()=>l==null?void 0:l.find(x=>x.slug===(t==null?void 0:t.machine_type)),[d,l]);return e.jsxs(b,{children:[e.jsx(_,{justify:"center",children:e.jsx(B,{order:4,children:t?t.name:n})}),!t&&e.jsx(j,{style:{fontStyle:"italic"},children:e.jsx(F,{id:"p6inm0"})}),e.jsx(I,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsxs(_,{justify:"space-between",children:[e.jsx(B,{order:4,children:e.jsx(F,{id:"Dm7Jy5"})}),e.jsx(X,{variant:"outline",onClick:()=>o(),children:e.jsx(Y,{})})]}),e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(K,{visible:s,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:i._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:i._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),e.jsx(c,{name:i._({id:"I+nMNp"}),value:f?f.name:t==null?void 0:t.machine_type,type:"text",link:f?`../type-${t==null?void 0:t.machine_type}`:void 0,detailDrawerLink:!0}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:i._({id:"umAemZ"}),value:(g=t==null?void 0:t.provider_plugin)==null?void 0:g.name,type:"text",link:((u=t==null?void 0:t.provider_plugin)==null?void 0:u.pk)!==null?`../../plugin/${(m=t==null?void 0:t.provider_plugin)==null?void 0:m.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:i._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:i._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"}),e.jsxs(_,{justify:"space-between",gap:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(F,{id:"UirGxE"}),":"]}),t&&(t==null?void 0:t.driver_errors.length)>0?e.jsx(q,{color:"red",style:{marginLeft:"10px"},children:t.driver_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(F,{id:"hIOaIF"})}),e.jsx(A,{w:"100%",children:t==null?void 0:t.driver_errors.map((x,h)=>e.jsx(A.Item,{children:e.jsx(N,{children:x})},`${h}-${x}`))})]})]})]})}),e.jsx(I,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsx(B,{order:4,children:e.jsx(F,{id:"Qf5DYN"})}),e.jsx(se,{props:{params:{driver:n}},renderMachineDrawer:!1,createProps:{machine_type:t==null?void 0:t.machine_type,driver:n}})]})})]})}function ye({props:n}){const d=U("machineTypes"),l=T(),o=p.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},{accessor:"description",title:i._({id:"Nu4oKW"})},E({accessor:"is_builtin",title:i._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(R,{title:i._({id:"qRwuAd"}),size:"xl",renderContent:s=>!s||!s.startsWith("type-")?!1:e.jsx(ge,{machineTypeSlug:s.replace("type-","")})}),e.jsx(R,{title:i._({id:"RYeia3"}),size:"xl",renderContent:s=>!s||!s.startsWith("driver-")?!1:e.jsx(ve,{machineDriverSlug:s.replace("driver-","")})}),e.jsx(G,{url:w(y.machine_types_list),tableState:d,columns:o,props:{...n,enableDownload:!1,enableSearch:!1,onRowClick:s=>l(`type-${s.slug}/`),params:{...n.params}}})]})}function Re(){var o;const{data:n,refetch:d}=L({queryKey:["machine-registry-status"],queryFn:()=>de.get(w(y.machine_registry_status)).then(s=>s.data),staleTime:1e4}),l=p.useMemo(()=>(n==null?void 0:n.registry_errors)&&n.registry_errors.length>0,[n]);return e.jsxs(a,{multiple:!0,defaultValue:["machinelist","machinetypes"],children:[e.jsxs(a.Item,{value:"machinelist",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"Qf5DYN"})})}),e.jsx(a.Panel,{children:e.jsx(se,{props:{}})})]}),e.jsxs(a.Item,{value:"machinetypes",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"XyzprV"})})}),e.jsx(a.Panel,{children:e.jsx(ye,{props:{}})})]}),e.jsxs(a.Item,{value:"machineerrors",children:[e.jsx(a.Control,{children:e.jsx(M,{size:"lg",children:i._({id:"Y7d3OC"})})}),e.jsx(a.Panel,{children:e.jsxs(b,{gap:"xs",children:[e.jsxs(_,{justify:"space-beteen",wrap:"nowrap",style:{width:"100%"},children:[l?e.jsx(W,{flex:10,color:"red",title:i._({id:"iXdfqc"}),icon:e.jsx(Z,{}),children:e.jsx(j,{children:i._({id:"2U2qZc"})})}):e.jsx(W,{flex:10,color:"green",title:i._({id:"32TD49"}),icon:e.jsx(Z,{}),children:e.jsx(j,{children:i._({id:"Jb0bCL"})})}),e.jsx(X,{variant:"outline",onClick:()=>d(),children:e.jsx(Y,{})})]}),l&&e.jsx(A,{children:(o=n==null?void 0:n.registry_errors)==null?void 0:o.map((s,t)=>e.jsx(A.Item,{children:e.jsx(N,{children:s.message})},t))})]})})]})]})}export{Re as default};
