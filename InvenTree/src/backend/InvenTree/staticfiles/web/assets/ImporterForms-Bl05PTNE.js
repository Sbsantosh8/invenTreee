import{r as n,n as O,i as a,j as e,cs as z,G as C,m as j,I as q,ej as U,d_ as v,d as H,S as g,J as G,bE as M,v as E,aM as P,bG as N,bD as h,bO as J,ek as Y,C as $,l as K,L as V,bB as W,cp as X,bF as Z,e2 as I}from"./vendor-9x6k4T-r.js";import{A as S,m as L,e as y}from"./index-Bd_yPD7D.js";import{u as ee}from"./UseInstance-Cb46b_w1.js";import{u as Q}from"./UseStatusCodes-gEst0ZT5.js";import{S as B}from"./ThemeContext-DRe09WSE.js";import{u as k}from"./DesktopAppView-D7dqNL6j.js";import{c as se}from"./navigation-BUwul1Ze.js";import{a as te,b as re,c as le,S as ie}from"./UseForm-C7xHtQGh.js";import{u as ae,R as ne,a as oe,I as de}from"./InvenTreeTable-KDc6oHjF.js";import{Y as ce}from"./YesNoButton-BsHbI51V.js";import{P as ue}from"./ColumnRenderers-CTwRHGdM.js";import{e as pe}from"./Instance-ZaRjKoLj.js";function fe({sessionId:t}){const{instance:s,setInstance:r,refreshInstance:o,instanceQuery:u}=ee({endpoint:S.import_session_list,pk:t,defaultValue:{}}),f=n.useCallback(l=>{r(l)},[]),p=Q({modelType:L.importsession}),x=n.useMemo(()=>(s==null?void 0:s.status)??p.INITIAL,[s,p]),c=n.useMemo(()=>(s==null?void 0:s.available_fields)??[],[s]),m=n.useMemo(()=>{let l=(s==null?void 0:s.columns)??[];return l=l.filter(i=>!!i),l=l.filter((i,d)=>l.indexOf(i)===d),l},[s.columns]),b=n.useMemo(()=>{var i;let l=((i=s==null?void 0:s.column_mappings)==null?void 0:i.map(d=>({...d,...c[d.field]??{}})))??[];return l=l.sort((d,_)=>d!=null&&d.required&&!(_!=null&&_.required)?-1:!(d!=null&&d.required)&&(_!=null&&_.required)?1:0),l},[s,m]),T=n.useMemo(()=>{var l;return((l=s==null?void 0:s.column_mappings)==null?void 0:l.filter(i=>!!i.column))??[]},[s]),F=n.useMemo(()=>(s==null?void 0:s.field_defaults)??{},[s]),w=n.useMemo(()=>(s==null?void 0:s.field_overrides)??{},[s]),R=n.useMemo(()=>(s==null?void 0:s.field_filters)??{},[s]),A=n.useMemo(()=>(s==null?void 0:s.row_count)??0,[s]),D=n.useMemo(()=>(s==null?void 0:s.completed_row_count)??0,[s]);return{sessionData:s,setSessionData:f,sessionId:t,refreshSession:o,sessionQuery:u,status:x,availableFields:c,availableColumns:m,columnMappings:b,mappedFields:T,fieldDefaults:F,fieldOverrides:w,fieldFilters:R,rowCount:A,completedRowCount:D}}function me({session:t,column:s,row:r,onEdit:o}){const u=n.useCallback(c=>{se(c),r.complete||o==null||o()},[o,r]),f=n.useMemo(()=>r.errors?(r==null?void 0:r.errors[s.field])??[]:[],[r.errors,s.field]),p=n.useMemo(()=>{const c=t.availableFields[s.field];if(!(r!=null&&r.data))return"-";switch(c==null?void 0:c.type){case"boolean":return e.jsx(ce,{value:r.data?r.data[s.field]:!1});case"related field":if(c.model&&r.data[s.field])return e.jsx(pe,{model:c.model,pk:r.data[s.field]});break}let m=r.data?r.data[s.field]??"":"";return m||(m="-"),m},[r.data,s.field,t.availableFields]),x=n.useMemo(()=>f.length==0,[f]);return e.jsxs(v,{disabled:x,openDelay:100,closeDelay:100,children:[e.jsx(v.Target,{children:e.jsx(C,{grow:!0,justify:"apart",onClick:u,children:e.jsx(C,{grow:!0,style:{flex:1},children:e.jsx(j,{size:"xs",c:x?void 0:"red",children:p})})})}),e.jsx(v.Dropdown,{children:e.jsx(g,{gap:"xs",children:f.map(c=>e.jsx(j,{size:"xs",c:"red",children:c},c))})})]})}function xe({session:t}){const s=k(),r=ae("dataimporter"),[o,u]=n.useState([]),f=n.useMemo(()=>{const l={};for(const i of o){const d=t.availableFields[i];if(d){let _=d.filters??{};t.fieldFilters[i]&&(_={..._,...t.fieldFilters[i]}),l[i]={...d,field_type:d.type,description:d.help_text,filters:_}}}return l},[o,t.availableFields,t.fieldFilters]),p=n.useCallback(l=>{O.show({title:a._({id:"fawxGh"}),message:a._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(z,{})}),s.post(y(S.import_session_accept_rows,t.sessionId),{rows:l}).catch(()=>{O.show({title:a._({id:"SlfejT"}),message:a._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{r.clearSelectedRecords(),O.hide("importing-rows"),r.refreshTable(),t.refreshSession()})},[t.sessionId,r.refreshTable]),[x,c]=n.useState({}),m=te({url:S.import_session_row_list,pk:x.pk,title:a._({id:"bo3Q/V"}),fields:f,initialData:x.data,fetchInitialData:!1,processFormData:l=>({data:{...x.data,...l}}),onFormSuccess:l=>r.updateRecord(l)}),b=n.useCallback((l,i)=>{c(l),u([i.field]),m.open()},[t,m]),T=re({url:S.import_session_row_list,pk:x.pk,title:a._({id:"f2AJjl"}),onFormSuccess:()=>r.refreshTable()}),F=n.useCallback(l=>{if(!l.errors)return[];const i=[];for(const d of Object.keys(l.errors))l.errors[d]&&(Array.isArray(l.errors[d])?l.errors[d].forEach(_=>{i.push(`${d}: ${_}`)}):i.push(l.errors[d].toString()));return i},[]),w=n.useMemo(()=>[{accessor:"row_index",title:a._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:i=>e.jsxs(C,{justify:"left",gap:"xs",children:[e.jsx(j,{size:"sm",children:i.row_index}),i.complete&&e.jsx(q,{color:"green",size:16}),!i.complete&&i.valid&&e.jsx(U,{color:"blue",size:16}),!i.complete&&!i.valid&&e.jsxs(v,{openDelay:50,closeDelay:100,children:[e.jsx(v.Target,{children:e.jsx(H,{color:"red",size:16})}),e.jsx(v.Dropdown,{children:e.jsxs(g,{gap:"xs",children:[e.jsxs(j,{children:[a._({id:"H14AdY"}),":"]}),F(i).map(d=>e.jsx(j,{size:"sm",c:"red",children:d},d))]})})]})]})},...t.mappedFields.map(i=>({accessor:i.field,title:i.label??i.column,sortable:!1,switchable:!0,render:d=>e.jsx(me,{session:t,column:i,row:d,onEdit:()=>b(d,i)})}))],[t]),R=n.useCallback(l=>[{title:a._({id:"g3UF2V"}),icon:e.jsx(z,{}),color:"green",hidden:l.complete||!l.valid,onClick:()=>{p([l.pk])}},ne({hidden:l.complete,onClick:()=>{c(l),u(t.mappedFields.map(i=>i.field)),m.open()}}),oe({onClick:()=>{c(l),T.open()}})],[t,p]),A=n.useMemo(()=>[{name:"valid",label:a._({id:"nfagfM"}),description:a._({id:"p385PV"}),type:"boolean"},{name:"complete",label:a._({id:"bD8I7O"}),description:a._({id:"ytCibL"}),type:"boolean"}],[]),D=n.useMemo(()=>{const l=r.hasSelectedRecords&&r.selectedRecords.every(i=>i.valid&&!i.complete);return[e.jsx(le,{disabled:!l,icon:e.jsx(z,{}),color:"green",tooltip:a._({id:"Fgr3ay"}),onClick:()=>{p(r.selectedRecords.map(i=>i.pk))}},"import-selected-rows")]},[r.hasSelectedRecords,r.selectedRecords]);return e.jsxs(e.Fragment,{children:[m.modal,T.modal,e.jsxs(g,{gap:"xs",children:[e.jsx(G,{shadow:"xs",p:"xs",children:e.jsxs(C,{grow:!0,justify:"apart",children:[e.jsx(j,{size:"lg",children:a._({id:"6dO0jk"})}),e.jsx(M,{}),e.jsx(ue,{maximum:t.rowCount,value:t.completedRowCount,progressLabel:!0}),e.jsx(M,{})]})}),e.jsx(de,{tableState:r,columns:w,url:y(S.import_session_row_list),props:{params:{session:t.sessionId},rowActions:R,tableActions:D,tableFilters:A,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{t.refreshSession()}}})]})]})}function he({column:t,options:s}){const r=k(),[o,u]=n.useState(""),[f,p]=n.useState(t.column??"");n.useEffect(()=>{p(t.column??"")},[t.column]);const x=n.useCallback(c=>{r.patch(y(S.import_session_column_mapping_list,t.pk),{column:c||""}).then(m=>{var b;p(((b=m.data)==null?void 0:b.column)??c),u("")}).catch(m=>{const b=m.response.data;u(b.column??b.non_field_errors??a._({id:"Vw8l6h"}))})},[t]);return e.jsx(J,{error:o,clearable:!0,searchable:!0,placeholder:a._({id:"TJu1/1"}),label:void 0,data:s,value:f,onChange:x})}function je({fieldName:t,session:s}){const r=k(),o=n.useCallback(f=>{const p={...s.fieldDefaults,[t]:f};r.patch(y(S.import_session_list,s.sessionId),{field_defaults:p}).then(x=>{s.setSessionData(x.data)}).catch(()=>{})},[t,s,s.fieldDefaults]),u=n.useMemo(()=>{let f=s.availableFields[t];return f&&(f={...f,value:s.fieldDefaults[t],field_type:f.type,description:f.help_text,onValueChange:o}),f},[t,s.availableFields,s.fieldDefaults]);return u&&e.jsx(ie,{fieldDefinition:u,hideLabels:!0})}function _e({session:t,column:s,options:r}){return e.jsxs(h.Tr,{children:[e.jsx(h.Td,{children:e.jsxs(C,{gap:"xs",children:[e.jsx(j,{fw:s.required?700:void 0,children:s.label??s.field}),s.required&&e.jsx(j,{c:"red",fw:700,children:"*"})]})}),e.jsx(h.Td,{children:e.jsx(j,{size:"sm",children:s.description})}),e.jsx(h.Td,{children:e.jsx(he,{column:s,options:r})}),e.jsx(h.Td,{children:e.jsx(je,{fieldName:s.field,session:t})})]},s.label??s.field)}function be({session:t}){const s=k(),[r,o]=n.useState(""),u=n.useCallback(()=>{const p=y(S.import_session_accept_fields,t.sessionId);s.post(p).then(()=>{t.refreshSession()}).catch(x=>{var c,m;o(((m=(c=x.response)==null?void 0:c.data)==null?void 0:m.error)??a._({id:"Vw8l6h"}))})},[t.sessionId]),f=n.useMemo(()=>[{value:"",label:a._({id:"ojDp4A"})},...t.availableColumns.map(p=>({value:p,label:p}))],[t.availableColumns]);return e.jsxs(g,{gap:"xs",children:[e.jsx(G,{shadow:"xs",p:"xs",children:e.jsxs(C,{grow:!0,justify:"apart",children:[e.jsx(j,{size:"lg",children:a._({id:"AHjxLx"})}),e.jsx(M,{}),e.jsx(E,{color:"green",variant:"filled",onClick:u,children:e.jsxs(C,{children:[e.jsx(P,{}),a._({id:"Y+Sfcf"})]})})]})}),r&&e.jsx(N,{color:"red",title:a._({id:"SlfejT"}),children:e.jsx(j,{children:r})}),e.jsxs(h,{children:[e.jsx(h.Thead,{children:e.jsxs(h.Tr,{children:[e.jsx(h.Th,{children:a._({id:"3mVQ03"})}),e.jsx(h.Th,{children:a._({id:"Us9epU"})}),e.jsx(h.Th,{children:a._({id:"qsUkVg"})}),e.jsx(h.Th,{children:a._({id:"aQ8swY"})})]})}),e.jsx(h.Tbody,{children:t.columnMappings.map(p=>e.jsx(_e,{session:t,column:p,options:f},`import-${p.field}}`))})]})]})}function ge({session:t}){const s=Q({modelType:L.importsession}),r=Y(()=>{t.status==s.IMPORTING&&t.refreshSession()},1e3);return n.useEffect(()=>(r.start(),r.stop),[]),e.jsx($,{children:e.jsx(K,{children:e.jsxs(g,{gap:"xs",children:[e.jsx(B,{size:"lg",children:a._({id:"JT9Hk8"})}),e.jsx(V,{}),e.jsxs(j,{size:"lg",children:[a._({id:"drGZDS"}),": ",t.sessionData.row_count]})]})})})}function Se({currentStep:t}){return e.jsxs(I,{active:t,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(I.Step,{label:a._({id:"IQ3gAw"})}),e.jsx(I.Step,{label:a._({id:"KXVPhI"})}),e.jsx(I.Step,{label:a._({id:"FhMhTR"})}),e.jsx(I.Step,{label:a._({id:"eHQfWJ"})}),e.jsx(I.Step,{label:a._({id:"b8ESNU"})})]})}function Oe({sessionId:t,opened:s,onClose:r}){const o=fe({sessionId:t}),u=Q({modelType:L.importsession}),f=n.useMemo(()=>{switch(o.status){case u.INITIAL:return 0;case u.MAPPING:return 1;case u.IMPORTING:return 2;case u.PROCESSING:return 3;case u.COMPLETE:return 4;default:return 0}},[o.status]),p=n.useMemo(()=>{if(o.sessionQuery.isLoading||o.sessionQuery.isFetching)return e.jsx(V,{});switch(o.status){case u.INITIAL:return e.jsx(j,{children:"Initial : TODO"});case u.MAPPING:return e.jsx(be,{session:o});case u.IMPORTING:return e.jsx(ge,{session:o});case u.PROCESSING:return e.jsx(xe,{session:o});case u.COMPLETE:return e.jsxs(g,{gap:"xs",children:[e.jsx(N,{color:"green",title:a._({id:"4fgz8U"}),icon:e.jsx(P,{}),children:a._({id:"zdT9Dy"})}),e.jsx(E,{color:"blue",onClick:r,children:a._({id:"yz7wBu"})})]});default:return e.jsxs(g,{gap:"xs",children:[e.jsxs(N,{color:"red",title:a._({id:"SC1Cur"}),icon:e.jsx(P,{}),children:[a._({id:"+6NHN9"}),": ",o.status]}),e.jsx(E,{color:"red",onClick:r,children:a._({id:"yz7wBu"})})]})}},[o.status,o.sessionQuery]),x=n.useMemo(()=>{var c;return e.jsxs(g,{gap:"xs",style:{width:"100%"},children:[e.jsxs(C,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(B,{size:"lg",children:((c=o.sessionData)==null?void 0:c.statusText)??a._({id:"CTRRU5"})}),e.jsx(Se,{currentStep:f}),e.jsx(M,{})]}),e.jsx(W,{})]})},[o.sessionData]);return e.jsx(X,{position:"bottom",size:"80%",title:x,opened:s,onClose:r,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsxs(g,{gap:"xs",children:[e.jsx(Z,{visible:o.sessionQuery.isFetching}),e.jsx(G,{p:"md",children:o.sessionQuery.isFetching||p})]})})}function ze(){return{data_file:{},model_type:{},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{Oe as I,ze as d};
