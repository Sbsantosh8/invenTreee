import{bA as K,r as d,i as t,j as e,G as Q,bC as ke,by as je,bz as ge,aB as Ce,m as w,bG as ye,d as Ie,I as Ae,aD as Oe,ce as Se,cp as Be,bE as le,bB as Fe,J as De,ci as G,cT as Y,Z as we,eq as Pe,b3 as Te,bq as Ee,ad as qe,er as ve,bk as Re,eo as Me,S as Le}from"./vendor-9x6k4T-r.js";import{A as Ne}from"./AdminButton-Dr56qn7X.js";import{P as ne}from"./PrimaryActionButton-CaaZRKkp.js";import{u as de,I as ue,k as ze,R as Ge,l as Ue}from"./InvenTreeTable-KDc6oHjF.js";import{I as We,D as V,a as Ze}from"./InstanceDetail-B4p22K57.js";import{D as He,N as Ve}from"./NotesPanel-BWqAJJ8r.js";import{B as Ye,O as Je,E as Ke,a as Xe,H as Qe,C as $e}from"./ActionDropdown-DlGcqXhK.js";import{P as et}from"./PageDetail-DJvgu_vJ.js";import{A as tt}from"./AttachmentPanel-D7Gvj1Gg.js";import{P as st}from"./PanelGroup-BCG3mCoU.js";import{b as at,S as it}from"./Instance-ZaRjKoLj.js";import{c as $,e as g,A as _,U as v,m as u,f as ot}from"./index-Bd_yPD7D.js";import{b as lt,c as nt,d as rt,e as ct,B as dt,u as ut}from"./BuildOrderTable-Cjwqdxki.js";import{u as P,a as pe,c as J,A as pt}from"./UseForm-C7xHtQGh.js";import{u as mt}from"./UseInstance-Cb46b_w1.js";import{u as _t}from"./UseStatusCodes-gEst0ZT5.js";import{B as bt}from"./BuildAllocatedStockTable-DIckwP_R.js";import{a as me}from"./BuildLineTable-DC18cgHW.js";import{P as ht}from"./YesNoButton-BsHbI51V.js";import{u as _e}from"./DesktopAppView-D7dqNL6j.js";import{f as ft}from"./formatters-MBbtNL9a.js";import{d as xt,e as kt,S as re}from"./StockItemTable-C1bOB_vf.js";import{g as X,i as be,a as he,S as jt,P as ce}from"./ColumnRenderers-CTwRHGdM.js";import{e as gt,I as D,S as Ct,C as yt}from"./ThemeContext-DRe09WSE.js";import"./navigation-BUwul1Ze.js";import"./dayjs.min-DUmzidR_.js";import"./GenericErrorPage-C2ho8aty.js";import"./NotFound-o4Sp_RYV.js";import"./PermissionDenied-Di_W_uvf.js";import"./PageTitle-D--W0kLm.js";import"./AttachmentLink-r3l6VS50.js";import"./ApiIcon-BBFuOj6_.js";import"./RemoteComponent-C0S0OuAi.js";import"./RemoveRowButton-PzDbXrvR.js";import"./UseGenerator-BZWzvoyo.js";import"./UsePlaceholder-C_lBT7aw.js";import"./UseFilter-DqHeVZaa.js";import"./OrderPartsWizard-BpRHlLRb.js";import"./CompanyForms-BzJpK2Vu.js";import"./PurchaseOrderForms-CTnFU4km.js";import"./RowExpansionIcon-CWOZUmFM.js";function It({buildId:i,partId:n}){const r=de("build-tests"),s=$(),C=_e(),{data:o}=K({queryKey:["build-test-templates",n,i],queryFn:async()=>n?C.get(g(_.part_test_template_list),{params:{part:n,include_inherited:!0,enabled:!0,required:!0}}).then(c=>c.data).catch(c=>[]):[]});d.useEffect(()=>{r.refreshTable()},[o]);const[x,h]=d.useState(0),[m,S]=d.useState(0),p=xt({partId:n,itemId:x,templateId:m}),T=P({url:g(_.stock_test_result_list),title:t._({id:"VzkBcq"}),fields:p,initialData:{template:m,result:!0},onFormSuccess:()=>r.refreshTable(),successMessage:t._({id:"VivtT0"})}),f=d.useMemo(()=>!o||o.length==0?[]:o.map(c=>({accessor:`test_${c.pk}`,title:c.test_name,sortable:!1,switchable:!0,render:b=>{const l=(b.tests||[]).filter(I=>I.template==c.pk).sort((I,B)=>B.pk-I.pk).shift();if(!l||l.result===void 0)return e.jsxs(Q,{gap:"xs",wrap:"nowrap",justify:"space-between",children:[e.jsx(ke,{color:"lightblue",variant:"filled",children:t._({id:"4bobEy"})}),e.jsx(je,{label:t._({id:"VzkBcq"}),children:e.jsx(ge,{size:"xs",color:"green",variant:"transparent",onClick:()=>{h(b.pk),S(c.pk),T.open()},children:e.jsx(Ce,{})})})]});const j=[];return l.value&&j.push(e.jsxs(w,{size:"sm",children:[t._({id:"wMHvYH"}),": ",l.value]},"value")),l.notes&&j.push(e.jsxs(w,{size:"sm",children:[t._({id:"1DBGsz"}),": ",l.notes]},"notes")),l.date&&j.push(e.jsxs(w,{size:"sm",children:[t._({id:"mYGY3B"}),": ",ft(l.date)]},"date")),l.user_detail&&j.push(e.jsx(at,{instance:l.user_detail},"user")),e.jsx(X,{value:e.jsx(ht,{value:l.result}),title:c.test_name,extra:j})}})),[o]),R=d.useMemo(()=>[...[{accessor:"stock",title:t._({id:"gILim+"}),sortable:!0,switchable:!1,render:b=>{if(b.serial)return`# ${b.serial}`;{const y=[];return b.batch&&y.push(e.jsxs(w,{size:"sm",children:[t._({id:"Vea6Aj"}),": ",b.batch]},"batch")),e.jsx(X,{value:e.jsxs(w,{children:[t._({id:"VbWX2u"}),": ",b.quantity]}),title:t._({id:"gILim+"}),extra:y})}}},be({accessor:"location_detail"})],...f],[f]),M=d.useMemo(()=>[{name:"is_building",label:t._({id:"BE5Q6v"}),description:t._({id:"AO8gAN"})}],[]),E=d.useMemo(()=>[],[]),k=d.useCallback(c=>[],[s]);return e.jsxs(e.Fragment,{children:[T.modal,e.jsx(ue,{url:g(_.stock_item_list),tableState:r,columns:R,props:{params:{part_detail:!0,location_detail:!0,tests:!0,build:i},rowActions:k,tableFilters:M,tableActions:E}})]})}function At({build:i,output:n,opened:r,close:s}){return e.jsxs(Be,{position:"bottom",size:"lg",title:e.jsxs(Q,{p:"md",wrap:"nowrap",justify:"space-apart",children:[e.jsx(Ct,{size:"lg",children:t._({id:"XqhL5S"})}),e.jsx(le,{h:"lg"}),e.jsx(he,{part:i.part_detail}),(n==null?void 0:n.serial)&&e.jsxs(w,{size:"sm",children:[t._({id:"AXeJt4"}),": ",n.serial]}),(n==null?void 0:n.batch)&&e.jsxs(w,{size:"sm",children:[t._({id:"Vea6Aj"}),": ",n.batch]}),e.jsx(le,{h:"lg"})]}),opened:r,onClose:s,withCloseButton:!0,closeOnEscape:!0,closeOnClickOutside:!0,styles:{header:{width:"100%"},title:{width:"100%"}},children:[e.jsx(Fe,{}),e.jsx(De,{p:"md",children:e.jsx(me,{build:i,output:n,params:{tracked:!0}})})]})}function Ot({build:i,refreshBuild:n}){var te,se,ae;const r=_e(),s=$(),C=gt(),o=de("build-outputs"),x=d.useMemo(()=>i.pk??-1,[i.pk]),h=d.useMemo(()=>i.part??-1,[i.part]),{data:m}=K({queryKey:["buildoutputtests",h,i],queryFn:async()=>{var a;return!h||h<0?[]:(a=i==null?void 0:i.part_detail)!=null&&a.testable?r.get(g(_.part_test_template_list),{params:{part:h,include_inherited:!0,enabled:!0,required:!0}}).then(A=>A.data).catch(()=>[]):[]}}),S=d.useMemo(()=>((m==null?void 0:m.length)??0)>0,[h,m]),{data:p,refetch:T}=K({queryKey:["trackeditems",x],queryFn:async()=>!x||x<0?[]:r.get(g(_.build_line_list),{params:{build:x,tracked:!0}}).then(a=>a.data).catch(()=>[])}),f=d.useMemo(()=>((p==null?void 0:p.length)??0)>0,[p]);d.useEffect(()=>{o.refreshTable()},[m,p,f,S]);const R=d.useCallback(a=>(a==null||a.forEach((A,N)=>{const q=[];let ie=0;m==null||m.forEach(F=>{var U;const O=(U=A.tests)==null?void 0:U.filter(z=>z.template==F.pk).sort((z,W)=>z.pk<W.pk?1:-1).shift();F!=null&&F.required&&(O!=null&&O.result)&&(ie+=1),q.push({name:F.test_name,result:(O==null?void 0:O.result)??!1})}),a[N].passCount=ie,a[N].results=q;let oe=0;p==null||p.forEach(F=>{var U,z;let O=0;(z=(U=F.allocations)==null?void 0:U.filter(W=>W.install_into==A.pk))==null||z.forEach(W=>{O+=W.quantity}),O>=F.bom_item_detail.quantity&&(oe+=1)}),a[N].fullyAllocated=oe}),a),[h,x,m,p]),M=lt({build:i}),E=P({url:g(_.build_output_create,x),title:t._({id:"jgrPxc"}),fields:M,timeout:1e4,initialData:{batch_code:i.batch,location:i.destination??((te=i.part_detail)==null?void 0:te.default_location)},table:o}),[k,c]=d.useState([]),b=nt({build:i,outputs:k,onFormSuccess:()=>{o.refreshTable(),n()}}),y=rt({build:i,outputs:k,onFormSuccess:()=>{o.refreshTable(),n()}}),l=ct({build:i,outputs:k,onFormSuccess:()=>{o.refreshTable(),n()}}),j=kt({create:!1,partId:h,stockItem:k[0]}),I=pe({url:_.stock_item_list,pk:(se=k[0])==null?void 0:se.pk,title:t._({id:"yP367G"}),fields:j,table:o}),B=P({url:_.build_order_deallocate,pk:i.pk,title:t._({id:"ZZL0Jx"}),preFormContent:e.jsx(ye,{color:"yellow",icon:e.jsx(Ie,{}),title:t._({id:"ZZL0Jx"}),children:t._({id:"1s7aZ2"})}),fields:{output:{hidden:!0}},initialData:{output:(ae=k[0])==null?void 0:ae.pk},onFormSuccess:()=>{T()}}),L=d.useMemo(()=>[e.jsx(J,{tooltip:t._({id:"jNuqfk"}),icon:e.jsx(D,{icon:"success"}),color:"green",disabled:!o.hasSelectedRecords,onClick:()=>{c(o.selectedRecords),b.open()}},"complete-selected-outputs"),e.jsx(J,{tooltip:t._({id:"ps+JBt"}),icon:e.jsx(D,{icon:"delete"}),color:"red",disabled:!o.hasSelectedRecords,onClick:()=>{c(o.selectedRecords),y.open()}},"scrap-selected-outputs"),e.jsx(J,{tooltip:t._({id:"MXiIO4"}),icon:e.jsx(D,{icon:"cancel"}),color:"red",disabled:!o.hasSelectedRecords,onClick:()=>{c(o.selectedRecords),l.open()}},"cancel-selected-outputs"),e.jsx(pt,{tooltip:t._({id:"jgrPxc"}),hidden:!s.hasAddRole(v.build),onClick:E.open},"add-build-output")],[s,o.selectedRecords,o.hasSelectedRecords]),Z=d.useCallback(a=>[ze({title:t._({id:"MeORpZ"}),modelId:a.pk,modelType:u.stockitem,navigate:C}),{title:t._({id:"9X8lAk"}),tooltip:t._({id:"kHgU4C"}),color:"blue",hidden:!f||!s.hasChangeRole(v.build),icon:e.jsx(D,{icon:"plus"}),onClick:()=>{c([a]),ee()}},{title:t._({id:"kp5oT9"}),tooltip:t._({id:"NLp8ve"}),color:"red",hidden:!f||!s.hasChangeRole(v.build),icon:e.jsx(D,{icon:"minus"}),onClick:()=>{c([a]),B.open()}},{title:t._({id:"bD8I7O"}),tooltip:t._({id:"BdMeIY"}),color:"green",icon:e.jsx(D,{icon:"success"}),onClick:()=>{c([a]),b.open()}},Ge({tooltip:t._({id:"yP367G"}),onClick:()=>{c([a]),I.open()}}),{title:t._({id:"5mspUE"}),tooltip:t._({id:"oise/z"}),icon:e.jsx(D,{icon:"delete"}),color:"red",onClick:()=>{c([a]),y.open()}},{title:t._({id:"dEgA5A"}),tooltip:t._({id:"ewDpt2"}),icon:e.jsx(D,{icon:"cancel"}),color:"red",onClick:()=>{c([a]),l.open()}}],[s,h,f]),H=d.useMemo(()=>[{accessor:"part",sortable:!0,render:a=>he({part:a==null?void 0:a.part_detail})},{accessor:"quantity",ordering:"stock",sortable:!0,switchable:!1,title:t._({id:"gILim+"}),render:a=>{let A=a.quantity;return a.serial&&(A=`# ${a.serial}`),A}},{accessor:"batch",sortable:!0},jt({accessor:"status",sortable:!0,model:u.stockitem}),be({accessor:"location_detail"}),{accessor:"allocations",sortable:!1,switchable:!1,hidden:!f,title:t._({id:"/b62hy"}),render:a=>e.jsx(ce,{progressLabel:!0,value:a.fullyAllocated??0,maximum:(p==null?void 0:p.length)??0})},{accessor:"tests",sortable:!1,switchable:!1,title:t._({id:"E4lFEY"}),hidden:!S,render:a=>{var N;const A=((N=a.results)==null?void 0:N.map(q=>q&&e.jsxs(Q,{justify:"left",wrap:"nowrap",children:[q.result?e.jsx(Ae,{color:"green"}):e.jsx(Oe,{color:"red"}),e.jsx(w,{children:q.name})]},q.name)))??[];return e.jsx(X,{value:e.jsx(ce,{progressLabel:!0,value:a.passCount??0,maximum:(m==null?void 0:m.length)??0}),extra:A,title:t._({id:"isbwWo"})})}}],[x,h,S,f,m,p]),[fe,{open:ee,close:xe}]=Se(!1);return e.jsxs(e.Fragment,{children:[E.modal,b.modal,y.modal,I.modal,B.modal,l.modal,e.jsx(At,{build:i,output:k[0],opened:fe,close:xe}),e.jsx(ue,{tableState:o,url:g(_.stock_item_list),columns:H,props:{params:{part_detail:!0,tests:!0,is_building:!0,build:x},enableLabels:!0,enableReports:!0,dataFormatter:R,tableActions:L,rowActions:Z,enableSelection:!0,onRowClick:a=>{f&&a.serial&&(c([a]),ee())}}})]})}function _s(){var b,y;const{id:i}=yt(),n=$(),r=_t({modelType:u.build}),{instance:s,refreshInstance:C,instanceQuery:o,requestStatus:x}=mt({endpoint:_.build_order_list,pk:i,params:{part_detail:!0},refetchOnMount:!0}),h=d.useMemo(()=>{var L,Z,H;if(o.isFetching)return e.jsx(G,{});const l=[{type:"link",name:"part",label:t._({id:"vgP+9p"}),model:u.part},{type:"text",name:"part_detail.IPN",icon:"part",label:t._({id:"3wXEsN"}),hidden:!((L=s.part_detail)!=null&&L.IPN),copy:!0},{type:"status",name:"status",label:t._({id:"uAQUqI"}),model:u.build},{type:"status",name:"status_custom_key",label:t._({id:"4DvUAJ"}),model:u.build,icon:"status",hidden:!s.status_custom_key||s.status_custom_key==s.status},{type:"text",name:"reference",label:t._({id:"N2C89m"}),copy:!0},{type:"text",name:"title",label:t._({id:"Nu4oKW"}),icon:"description",copy:!0},{type:"link",name:"parent",icon:"builds",label:t._({id:"jqsG41"}),model_field:"reference",model:u.build,hidden:!s.parent}],j=[{type:"text",name:"quantity",label:t._({id:"Ee+3kG"})},{type:"progressbar",name:"completed",icon:"progress",total:s.quantity,progress:s.completed,label:t._({id:"Mzv4va"})},{type:"link",name:"sales_order",label:t._({id:"LozYBo"}),icon:"sales_orders",model:u.salesorder,model_field:"reference",hidden:!s.sales_order}],I=[{type:"text",name:"issued_by",label:t._({id:"kmUN8p"}),icon:"user",badge:"user"},{type:"text",name:"responsible",label:t._({id:"XQACoK"}),badge:"owner",hidden:!s.responsible},{type:"text",name:"creation_date",label:t._({id:"d+F6q9"}),icon:"calendar",hidden:!s.creation_date},{type:"text",name:"target_date",label:t._({id:"ZmykKo"}),icon:"calendar",hidden:!s.target_date},{type:"text",name:"completion_date",label:t._({id:"qqWcBV"}),icon:"calendar",hidden:!s.completion_date},{type:"text",name:"project_code_label",label:t._({id:"Sdfr6G"}),icon:"reference",copy:!0,hidden:!s.project_code}],B=[{type:"link",name:"take_from",icon:"location",model:u.stocklocation,label:t._({id:"/00Ond"}),backup_value:t._({id:"aZD9Yv"})},{type:"link",name:"destination",icon:"location",model:u.stocklocation,label:t._({id:"o35LCI"}),hidden:!s.destination},{type:"text",name:"batch",label:t._({id:"Vea6Aj"}),hidden:!s.batch,copy:!0}];return e.jsxs(We,{children:[e.jsxs(Y,{children:[e.jsx(Y.Col,{span:4,children:e.jsx(He,{appRole:v.part,apiPath:_.part_list,src:((Z=s.part_detail)==null?void 0:Z.image)??((H=s.part_detail)==null?void 0:H.thumbnail),pk:s.part})}),e.jsx(Y.Col,{span:8,children:e.jsx(V,{fields:l,item:s})})]}),e.jsx(V,{fields:j,item:s}),e.jsx(V,{fields:I,item:s}),e.jsx(V,{fields:B,item:s})]})},[s,o]),m=d.useMemo(()=>{var l;return[{name:"details",label:t._({id:"98Q4bz"}),icon:e.jsx(we,{}),content:h},{name:"line-items",label:t._({id:"SgduFH"}),icon:e.jsx(Pe,{}),content:s!=null&&s.pk?e.jsx(me,{build:s}):e.jsx(G,{})},{name:"incomplete-outputs",label:t._({id:"E9en8O"}),icon:e.jsx(Te,{}),content:s.pk?e.jsx(Ot,{build:s,refreshBuild:C}):e.jsx(G,{}),hidden:s.status==r.COMPLETE||s.status==r.CANCELLED},{name:"complete-outputs",label:t._({id:"Mzv4va"}),icon:e.jsx(Ee,{}),content:e.jsx(re,{allowAdd:!1,tableName:"build-outputs",params:{build:i,is_building:!1}})},{name:"allocated-stock",label:t._({id:"MD2yP5"}),icon:e.jsx(qe,{}),hidden:s.status==r.COMPLETE||s.status==r.CANCELLED,content:s.pk?e.jsx(bt,{buildId:s.pk,showPartInfo:!0,allowEdit:!0}):e.jsx(G,{})},{name:"consumed-stock",label:t._({id:"US3GCq"}),icon:e.jsx(ve,{}),content:e.jsx(re,{allowAdd:!1,tableName:"build-consumed",showLocation:!1,params:{consumed_by:i}})},{name:"child-orders",label:t._({id:"CVlgqS"}),icon:e.jsx(Re,{}),content:s.pk?e.jsx(dt,{parentBuildId:s.pk}):e.jsx(G,{})},{name:"test-results",label:t._({id:"isbwWo"}),icon:e.jsx(Me,{}),hidden:!((l=s.part_detail)!=null&&l.testable),content:s.pk?e.jsx(It,{buildId:s.pk,partId:s.part}):e.jsx(G,{})},tt({model_type:u.build,model_id:s.pk}),Ve({model_type:u.build,model_id:s.pk})]},[s,i,n,r]),S=ut({create:!1}),p=pe({url:_.build_order_list,pk:s.pk,title:t._({id:"B7ynKf"}),fields:S,onFormSuccess:C}),T=P({url:_.build_order_list,title:t._({id:"59jtLx"}),fields:S,initialData:{...s,reference:void 0},follow:!0,modelType:u.build}),f=P({url:g(_.build_order_cancel,s.pk),title:t._({id:"MTYJu1"}),onFormSuccess:C,successMessage:t._({id:"H5qWhm"}),preFormWarning:t._({id:"MPFqR0"}),fields:{remove_allocated_stock:{},remove_incomplete_outputs:{}}}),R=P({url:g(_.build_order_hold,s.pk),title:t._({id:"hZIvSn"}),onFormSuccess:C,preFormWarning:t._({id:"3Wfk51"}),successMessage:t._({id:"0NH/ob"})}),M=P({url:g(_.build_order_issue,s.pk),title:t._({id:"Z4Rl+B"}),onFormSuccess:C,preFormWarning:t._({id:"lLiNZC"}),successMessage:t._({id:"R/WvFK"})}),E=P({url:g(_.build_order_complete,s.pk),title:t._({id:"Q/TP3B"}),onFormSuccess:C,preFormWarning:t._({id:"DYITap"}),successMessage:t._({id:"W7TghJ"}),fields:{accept_overallocated:{},accept_unallocated:{},accept_incomplete:{}}}),k=d.useMemo(()=>{const l=n.hasChangeRole(v.build),j=l&&(s.status==r.PENDING||s.status==r.ON_HOLD),I=l&&s.status==r.PRODUCTION,B=l&&(s.status==r.PENDING||s.status==r.PRODUCTION),L=l&&(s.status==r.PENDING||s.status==r.ON_HOLD||s.status==r.PRODUCTION);return[e.jsx(ne,{title:t._({id:"WajCDs"}),icon:"issue",hidden:!j,color:"blue",onClick:M.open}),e.jsx(ne,{title:t._({id:"NPZqBL"}),icon:"complete",hidden:!I,color:"green",onClick:E.open}),e.jsx(Ne,{model:u.build,id:s.pk}),e.jsx(Ye,{model:u.build,pk:s.pk,hash:s==null?void 0:s.barcode_hash}),e.jsx(Ue,{modelType:u.build,items:[s.pk],enableReports:!0}),e.jsx(Je,{tooltip:t._({id:"tDgG1Y"}),actions:[Ke({onClick:()=>p.open(),hidden:!l,tooltip:t._({id:"mVeaUg"})}),Xe({onClick:()=>T.open(),tooltip:t._({id:"oi/3Pq"}),hidden:!n.hasAddRole(v.build)}),Qe({tooltip:t._({id:"20mLBC"}),hidden:!B,onClick:R.open}),$e({tooltip:t._({id:"tVJk4q"}),onClick:f.open,hidden:!L})]})]},[i,s,n,r]),c=d.useMemo(()=>o.isFetching?[]:[e.jsx(it,{status:s.status_custom_key,type:u.build,options:{size:"lg"}})],[s,o]);return e.jsxs(e.Fragment,{children:[p.modal,T.modal,f.modal,R.modal,M.modal,E.modal,e.jsx(Ze,{status:x,loading:o.isFetching,requiredRole:v.build,children:e.jsxs(Le,{gap:"xs",children:[e.jsx(et,{title:`${t._({id:"YxwWvi"})}: ${s.reference}`,subtitle:s.title,badges:c,editAction:p.open,editEnabled:n.hasChangePermission(u.part),imageUrl:((b=s.part_detail)==null?void 0:b.image)??((y=s.part_detail)==null?void 0:y.thumbnail),breadcrumbs:[{name:t._({id:"3ctapx"}),url:"/manufacturing"},{name:s.reference,url:ot(u.build,s.pk)}],actions:k}),e.jsx(st,{pageKey:"build",panels:m,instance:s,model:u.build,id:s.pk})]})})]})}export{_s as default};
